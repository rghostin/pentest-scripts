#!/bin/bash

# Helper to transfer file manually
# Encode file B64, split in chunks, copy each chunk to clipboard, reconstruct at target
# Attacker pastes the copied commands on the target host


set -e

MAX_CHUNK="800K"

if [ $# -lt 1 ]; then
	echo "Usage: $0 <file_to_transfer> <chunk_size=800K>"
	exit 1
fi



FILE_ORIG="$1"

if [ ! -z $2 ]; then
	MAX_CHUNK="$2"
fi

FILE_NAME=$(basename "$FILE_ORIG")

# set up
TMP_DIR=$(mktemp -d)
echo "[*] Created workspace $TMP_DIR"
cp "$FILE_ORIG" "$TMP_DIR"
FILE="$TMP_DIR/$FILE_NAME"
FILE_NAME_B64="${FILE_NAME}.b64"
FILE_B64="$TMP_DIR/$FILE_NAME_B64"
cd "$TMP_DIR"


echo "[*] Encoding file to B64"
cat "${FILE}" | base64 > "$FILE_B64"

echo "[*] Splitting file"
split --verbose -b"$MAX_CHUNK" "$FILE_B64"


for f in xa*; do
	f_b64=$(cat "${f}")
	cmd="echo -n \"${f_b64}\" >> ${FILE_NAME_B64}"
	echo "${cmd}" | xclip -selection clipboard
	echo " > Copied command for $f"
	read -p "Press ENTER to continue"
done


decode_cmd="base64 -d ${FILE_NAME_B64} > ${FILE_NAME} && md5sum ${FILE_NAME}"
echo "${decode_cmd}" | xclip -selection clipboard
echo "> Copied decode command: ${decode_cmd}"
echo "[!] Original hash : $(md5sum ${FILE})"


# cleanup
echo -e "\n\n[*] Cleaning up"
rm -rf "$TMP_DIR"

echo "[*] Done"
